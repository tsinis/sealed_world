name: verify_packages

on:
  push:
    branches: [main]
    paths:
      - "packages/**"
  pull_request:
    branches: [main]
    paths:
      - "packages/**"
      - ".github/workflows/verify_packages.yaml"

jobs:
  detect-changed-packages:
    name: Detect Changed Packages
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changes.outputs.all_changed_files }}
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Get changed directories
        id: changes
        uses: tj-actions/changed-files@v45.0.6
        with:
          dir_names: true
          json: true
          files: packages/[!_]*/**
          files_ignore: |
            **/*.md
            **/example/**
            **/analysis_options.yaml
            **/flutter_analysis_options.yaml
          diff_relative: true
          dir_names_exclude_current_dir: true
          since_last_remote_commit: true

  verify-changed-packages:
    needs: detect-changed-packages
    if: needs.detect-changed-packages.outputs.matrix != '[]'
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJSON(needs.detect-changed-packages.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
      - name: Verify Package
        uses: ./.github/workflows/verify_package_workflow.yaml
        with:
          package_name: ${{ matrix.package }}
          is_flutter: ${{ contains(matrix.package, 'world_') }}
          secrets: inherit
